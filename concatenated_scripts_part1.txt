# Concatenated Project Code - Part 1 of 3
# Generated: 2025-05-09 15:09:19
# Root Directory: /Users/gianmariatroiani/Documents/misophonia-companion-v3
================================================================================

# Directory Structure
################################################################################
├── .DS_Store
├── .gitignore
├── README.md
├── eslint.config.js
├── index.html
├── js-requirements.md
├── netlify/
│   └── functions/
│       ├── _utils.js
│       ├── chat.js
│       ├── rag.js
│       ├── research.js
│       └── search.js
├── netlify.toml
├── package.json
├── public/
│   ├── icon-192.png
│   ├── icon-512.png
│   ├── manifest.json
│   └── vite.svg
├── requirements.txt
├── scripts/
│   ├── docling_batch_convert_with_metadata.py
│   ├── ingest.js
│   ├── migrate_to_supabase.js
│   ├── old/
│   ├── optimized_batch_process_gian_v1.py
│   ├── process_research_metadata.py
│   ├── processed_files.json
│   ├── rag_web_app_v9.py
│   ├── resilient_batch_embedding_generator_gian_v1.1.py
│   ├── templates/
│   │   ├── index.html
│   │   ├── rag_web_interface_gian_v1 copy.py
│   │   └── rag_web_interface_gian_v1.py
│   └── test_vector_search.py
├── server/
│   ├── index.js
│   └── package.json
├── src/
│   ├── App.css
│   ├── App.jsx
│   ├── RagAssistant.jsx
│   ├── TermsModal.jsx
│   ├── assets/
│   │   ├── bot-avatar.png
│   │   ├── react.svg
│   │   └── user-avatar.png
│   ├── index.css
│   └── main.jsx
└── vite.config.js


================================================================================


################################################################################
# File: scripts/processed_files.json
################################################################################

[
  "Kumar 2017 The Brain Basis for Misophonia.txt",
  "Guetta 2025 Misophonia is related to stress but not directly wtih traumatic stress.txt",
  "Kashihara 2017 Attentive Observation is Essential for the Misattribution of agency to self-performance.txt",
  "Godpole 2025 A Young Woman with Misophonia Leading to Unwanted Sexual Arousal.txt",
  "Rinaldi 2022 Autistic traits, emotion regulation, and sensory sensitivities in children.txt",
  "Hodges 2014 Medical Education Meet Foucault.txt",
  "Mollman 2024 a conceptual framework on body representations.txt",
  "Kinney 2024 Neurodiversity_and_Epistemic_Justice.txt",
  "Langguth 2024 Tinnitus Clinical Insights.txt",
  "aksan et al. 2023 Evaluating Traumatic Event Scoring Schemas.txt",
  "Cerliani 2015 Increased functional connectivity between subcortical and cortical resting-state networks in autism spectrum disorder.txt",
  "Kornelsen 2023 Structural differences in the cortex of individuals who experience the autonomous.txt",
  "Trumbull 2023 Using a standardized sound set to help characterize misophonia.txt",
  "Aryal 2023 Pre Proof Awareness and Perspectives of Audiologists on Assessment and Management of Misophonia in India.txt",
  "Berger 2024 Human Insula Neurons respond to Simple Sounds During Passive Listening.txt",
  "Sajid 2021 Paradigm shifting from bio medical to bio psycho social and role of medical social work.txt",
  "Soler et al 2024 Parent-young person lived experience of sensory dysregulation in children with tic disorders  a qualitative study.txt",
  "Stalias Mantzikos 2023 Early Maladaptive Schemas in Misophonia.txt",
  "McGeoch and Rouw 2020 How everyday sounds can trigger strong emotions asmr misophonia and the feeling of wellbeing.txt",
  "Rosenthal 2023 Editorial Final.txt",
  "Munoz 2025 Assessment of auditory conditions in misophonia treatment research a scoping review.txt",
  "Sonuga Barke and Thapar 2021 The Neurodiversity Concept.txt",
  "Kazemi et al Effects of Cognitive Behavioral Therapy for Misophonia.txt",
  "Andermane 2024 A symptom network model of misophonia  From heightened sensory sensitivity to clinical.txt",
  "LeDoux 2020 Seeing Consciousness Through the lens of Memory.txt",
  "O_Connor 2013 How has neuroscience affected lay understandings of personalhood a review of the evidence.txt",
  "Jager Inge 2022 Synopsis and Qualitative Evaluation of a Treatment Protocol Group CBT.txt",
  "Taschereau dash Domouchel 2021 Putting the mental back Notes.txt",
  "Wunrow 2024 Selective noise cancelling application for misophonia treatment.txt",
  "Simner 2023 Misophonia  self\u2010harm and suicidal ideation.txt",
  "Oszczapinska et al 2024 The impact of disgusting sounds on pupil diameter.txt",
  "Journal of Hearing Science.txt",
  "aazh-et-al-2024-a-preliminary-analysis-of-the-clinical-effectiveness-of-audiologist-delivered-cognitive-behavioral.txt",
  "Ahmmed and Vijayakumar 2024 Distinguishing Between Hyperacusis and Misophonia in Children with auditory processing disorder.txt",
  "Katikar et al 2025 Sensory processing in autism spectrum disorder insights into misophonia and hyperacusis in a pediatric population.txt",
  "Dwyer 2023 Haibutation of auditory responsesin young autistic and neurotypical hildren.txt",
  "Jager 2021 EMDR therapy for misophonia a pilot study of case series.txt",
  "Agnieszka 2023 Increased misophonia in self reported Autonomous sensory meridian response.txt",
  "Sharp 2024 For Whom the Bell Tolls.txt",
  "Patro et al 2025 Investigating Neurophysiological, perceptual, and cognitive mechanicisms in misophonia.txt",
  "Begenen 2023 A comparison of clinical features and executive functions between patients with obsessive compulsivedisorder with and without misophonia.txt",
  "Frank  2019 Inattention in Misophonia.txt",
  "Guetta 2020 Development and psychometric exploration of a semi-structured clinical interview for misophonia.txt",
  "Forester 2024 Back to the future progressing memory research in eating disorders.txt",
  "Dibb and Golding 2023 A Longitudinal Investigation of quality of life and negative emotions in misophonia.txt",
  "Meltzoff 2007 Like Me.txt",
  "Pfeiffer 2022 Misophonia in Children and adolescents a narrative review translation from German.txt",
  "Heller 2025 Reassigning sources of misophonic trigger sounds to change their unpleasantness_ Testing alternative mechanisms with a new set of movies, paintings, and words.txt",
  "Bernstein 2013 A brief course of cognitive behavioral therapy for the treatment of misophonia.txt",
  "Kidd and Carel 2017 Epistemic Injustice and Illness.txt",
  "Mahzouni et al 2024  Positive attributable visual sources attenuate the impact of trigger sounds in misophonia.txt",
  "Ghorbani 2023 The Mediating Role of Sensory Processing.txt",
  "Makani 2024 Hyperacusis in Tinnitus Individuals is Associated with Smaller Gray Matter.txt",
  "Armstrong 2023 Factors associated with internalizing and externalizing symptoms in a clinical sample of youth with misophonia.txt",
  "Newby 2024 Sensory processing in children with Paediatric Acute\u2010onset Neuropsychiatric Syndrome (1).txt",
  "Ay 2024 The mediating role of anxiety in the relationship between misophonia and quality of life.txt",
  "Kumar 2021 Motor Basis.txt",
  "Fricker 2017 Evolving Concepts of EI_pre-publication.txt",
  "Cavana and Seri (2015) Misophonia Current Perspectives.txt",
  "Chaves Baldini 2024 Existential concerns in psychopathology  a transdiagnostic network analysis existential concerns in psychopathology.txt",
  "Lewin 2021 Transdiagnostic cognitive behavioral therapy for misophonia in youth methods for a clinical trial and four pilot cases.txt",
  "Rappoldt 2023 Effectiveness of an innovative treatment protocol for misophonia in children and adolescents.txt",
  "Jacobs 2023 Threat Perception Emotion Review.txt",
  "Aryal 2023 Auditory Cortical Functioning in Individuals with Misophonia.txt",
  "Longhurst 2007 using the body as a instrument of research.txt",
  "Heller et al 2025 Reassigning sources of misophonic trigger sounds to change their unpleasantness.txt",
  "Accardo 2024 Valuing Neurodiversity on Campus.txt",
  "Fierro 2024 Psychometric properties of a self-perception questionnaire for adults with suspected misophonia preprint.txt",
  "Dozier 2024 Safe and Sound Protocol with Brief Therapy for Misophonia A Pilot Study.txt",
  "Timms 2022 Auditory symptoms and autistic spectrum disorder a scoping review and recommendations.txt",
  "Natalini 2024 Megacognitive interpersonal therapy for Misophonia Single Case Study.txt",
  "K\u0131l\u0131c\u0327 Cengiz 2021 The Prevalence and Characteristics of misophonia in ankara turkey.txt",
  "Aazh 2023 Psychometric Evaluation of the Hyperausis Impact Questionaniare.txt",
  "Webb 2022 B Blockers for the treatment of misophonia and misokinesia.txt",
  "The neurobiology of misophonia and implications for novel, neuroscience-driven interventions.txt",
  "Taschereau-Dumouche 2022 Putting the mental back in mental disorders.txt",
  "Engel 1977 The Need for a New Medical Model A Challenge for Biomedicine.txt",
  "Lynch 2023 Introduction to the Special Issue on Covid 19.txt",
  "Orloff 2023 Curation of FOAMS A free Open Access Misophonia Stimuli Database.txt",
  "Bagrowska 2022 Do they make these sounds to hurt me the mediating role of emotion regulation,.txt",
  "Smith et al 2021 Taking knowledge production seriously in responsible research and innovation (1).txt",
  "Neacsiu 2024 An experimental examination of neurostimulation and cognitive restructuring as potential components for misophonia interventions.txt",
  "Karupaiah and Prabhu 2025 Auditory Brainstrem Response Patterns in Misophonia A Comparative Study.txt",
  "O_Conner 2025 The skater s ear  a sensuous complexity of skateboarding sound.txt",
  "Siepsiak 2023 Misophonia in Children and Adolescents.txt",
  "Ferrer-Torres 2022 Misophonia a Systematic Review of Current and Future Trends in this Emerging Clinical Field.txt",
  "Norena 2023 Civilisation of manners and misophonia.txt",
  "Berg 2019 Evidence Based Practice in psychology Fails to be Tripartite A Conceptual Critique of the Scientocentrism.txt",
  "Guzick 2022 Clinical characteristics, impairment, and psychiatric morbidity in102 youth with misophonia.txt",
  "Education and Occupation in The Misophonia Podcast.txt",
  "Kook et al 2024 Quality of Life among youth with misophonia.txt",
  "Musicality Misophonia Sensitivity and Responsiveness to Misopho.txt",
  "Smees 2024 Dissociable effects of hyperacusis and misophonia severity imply different mechanisms of decreased sound tolerance.txt",
  "Tyson 2023 Undergrad The Relationship Between Coping Behaviors and Misophonia Symptom.txt",
  "Bagrowska 2022 Do they make these sounds to hurt me (no notes).txt",
  "Ringer 2023  That sounds awful  Does sound unpleasantness modulate the mismatch.txt",
  "ASMR 2023 Review.txt",
  "Schroder 2013 Misophonia Diagnostic Criteria for a New Psychiatric Disorder.txt",
  "Mednicoff  2023 Misophonia Reactions in the General population.txt",
  "Cederroth Christopher 2019 Editorial Towards an understanding of tinnitus heterogeneity.txt",
  "Aryal  2023 Auditory Brainstem Functioning in Individuals with Misophonia.txt",
  "Horsfall 2024 Misophonia Development from Onset to College Age.txt",
  "LeDoux 2021 As soon as there was life, there was danger.txt",
  "Carel and Kidd 2017 Epistemic Injustice In Medicine and Healthcare.txt",
  "Edelstein 2020 context influences how individuals with misophonia respond to sounds.txt",
  "Raymond 2023 MisoQuest_Paper_Preprint.txt",
  "Cavanna 2014 What is misophonia and how can we treat it.txt",
  "Gerlus 2025 Abstract.txt",
  "Robinson 2023 The lived experiences of people with misophonia.txt",
  "Lorenzatti 2023 Aphantasia a Philosophical approach.txt",
  "Guzick et al 2024 Internet based parent led cognitive behavioral therapy for autistic youth with anxiety related disorders.txt",
  "Sanchez 2017 Familial misophonia.txt",
  "Siepsiak and Dragan 2019 Misophonia A Review of Research Results and Theoretical Concepts.txt",
  "Aazh and Kula 2024 The Sound Sensitivity Symptoms Questionnaire Version 2.0.txt",
  "Abramovitch 2024 A neuopsychological study of misophonia.txt",
  "Kevin 2023 Neurodiversity and autism between disability and difference preprint.txt",
  "Fricker-2013-Epistemicjusticecondition.txt",
  "Moscovici Notes Toward a Description of Social Representations.txt",
  "AAzh 2023 Commentary on Consensus Definition.txt",
  "Renaud 2024 Student_s Self Reported Experience of Soundscape.txt",
  "Rosenthal 2022 Phenotyping misophonia Psychiatric disorders and medical health correlates.txt",
  "Wu (2014) Misophonia Incidence Phenomenology, and Clincial Correlates in an undergraduate student sample.txt",
  "Dacremont 1995 Spectral composition.txt",
  "Webb 2024 Steriods for Misophonia.txt",
  "Johnson (1993) Source Monitoring.txt",
  "Eldesouky and Gross 2019 Emotion Regulation Goals an Individual difference perspectives.txt",
  "Trenholm Jensen 2022 Beyond tingles an exploratory qualitative study of autonomous sensory meridian response asmr.txt",
  "Daniels Emily 2020 Severity of misophonia symptoms worse cognitive control.txt",
  "howlett 2023 Investigating Self report and neuropsychological assessments of cognitive flexibility in people with and without persistent pain.txt",
  "McKee et al 2024 sound-sensitivities-in-the-quiet-environment-implications-and-strategies-for-management.txt",
  "Zai 2022 Misophonia A Detailed Case Series and Literature Review.txt",
  "Hayes 2023 Psychometric evaluation and misophonic experience.txt",
  "Brown 2019 Why Study the History of Neuroscience.txt",
  "Simner 2022 Attention flexibility and imagery in misophonia.txt",
  "mohebian 2023 the_analysis_of_the_cognitive_function_parameters.6.txt",
  "Grayless 2021 Assessment and Management Case Study.txt",
  "Poldoly 2025 A randomized controlled trial evaluating an mHealth intervention for anger-related cognitions in misophonia.txt",
  "Berger 2023 A Social Cognition Perspective on Misophonia.txt",
  "Lawson Rebecca 2017 Adults with Autism overestimate the volatility of the sensory environment.txt",
  "Siepsiak 2020 Development and Psychometric Properties of MisoQuest.txt",
  "Claiborn et al 2020 Self-Identified Misophonia Phenomenology, Impact and Clinical Correlates.txt",
  "Kotler 2022 First Few seconds for flow a comprehensive proposal of the neurobiology and neurodynamics of state onset.txt",
  "Norris Jordan 2022 Toward a Multi-Dimensional Understanding of Misophonia.txt",
  "Chalmers 1995 Facing Up to the Problem of Consciousness.txt",
  "Yektatalab 2022 The Prevalence of Misophonia and its relationship with OCD.txt",
  "Spencer 2023 Mindfulness and cognitive emotion regulation in pediatric misophonia.txt",
  "Siepsiak 2023 Does context matter in misophonia a multi method experiemental investigation.txt",
  "Jastreboff Pawel 2001 Components of decreased sound tolerance.txt",
  "Smees 2022 The Parent completed Glasgow Sensory Questionnaire Exploring Children_s Sensory Sensitivities and Their Relationship to Well being.txt",
  "Fricker Virtue.txt",
  "Mattson 2023 A Systematic Review of treatments for misophonia.txt",
  "Grossini 2022 Misophonia Analysis of the neuroanatomic patterns at the basisof psychiatric symptoms.txt",
  "Hoy 1991 A History of consciousness from Kant and Hegel to Derrida and Foucault.txt",
  "Cromby 2007 Integrating social science with neuroscience.txt",
  "deGee et al 2024 Sound evoked pupil dilation quantifies misophonia symptoms.txt",
  "Yamazawa 2025 A study on the prevalence of hyperacusis among university students.txt",
  "rose-2001-the-politics-of-life-itself.txt",
  "Wingen 2022 Caution, Preprint Brief Explanations Allow Nonscientists to Differentiate.txt",
  "Aryal 2022 Misophonia Prevalence, impact and co-morbidity among Mysore University Students in India.txt",
  "Hamida 2024 Guidance to investigate University students_ responses to sound.txt",
  "Gregory 2023 Targeting Beliefs and behaviors in misophonia.txt",
  "Radoilska and Foreman 2023 Epistemic Justice is both a legitimate and an integral goal of psychiatry.txt",
  "Williams 2023 Prevalence of decreased sound tolerance.txt",
  "O_Reilley et al 2025 Examining Physiological Responses to Misophonic Triggers.txt",
  "Feinberg 2020 Phenomenal Consciousness and Emergence Eliminating the Explanatory Gap.txt",
  "Watson 2022 Investigation of a Misophonia and Fluid Intelligence Relationship.txt",
  "Dixon et al 2024 Emotion Dysregulation in misophonia findings from a nationally representative sample.txt",
  "Lau 2022 The Mnemonic Basis of Subjective Experience.txt",
  "Cowan et al. 2021 Misophonia A Psychological Model and Proposed Treatment.txt",
  "Paul 2005 Perception and Production of Prosody by Speakers with autism spectrum disorder.txt",
  "Grasswick 2017 Epistemic Injustice in Science.txt",
  "Guetta 2022 Examining emotional functioning in misophonia the role of affective instability.txt",
  "Vijayakumar 2025 A Retrospective Study of Audiological Characteristics of Hyperacusis versus Misophonia in children with auditory processing disorder.txt",
  "Erturk 2023 Examining the correlation between misophonia symptoms and autistic traits in general population.txt",
  "Tomasello 2003 What Makes Human Cognition Unique.txt",
  "Association Prevalence of Misophonia in adolescents and adults across the globe.txt",
  "Kumar 2014 Misophonia a disorder of emotion processing of sound.txt",
  "Ecker 2022 Psychotherapies for a new humanism.txt",
  "Edelstein 2013 Miosphonia Physiological investigations.txt",
  "Ash (2022) Mimicry in misophonia Manuscript Preprint.txt",
  "Zabelina 2015 Creativity and sensory gating indexed by the P50.txt",
  "Ward 2022 The Relationship Between Self-Reported Misophonia Symptoms and Auditory Aversive Generalized Leaning A Preliminary Report.txt",
  "Magrini 2023 Acoustic Quality of the External Environment.txt",
  "Krog 2024 Preliminary validation of the Norwegian version of the Berlin Misophonia-1.txt",
  "Qin 2024 Development and validation of the perceived restorative soundscape scale for children.txt",
  "Dinishak 2019 Autism, aspect perception and neurodiversity.txt",
  "INVER_logo_lockup_cmyk_fullcolor.txt",
  "Regencia et al 2025 Level of depression anxiety and stress among emerging adults in the Phillipines.txt",
  "Fishkin 2023 Charlie Haden_s Earplugs (1).txt",
  "Shan et al 2024 Network analysis of misophonia symptoms using the Duke Misophonia Questionnaire.txt",
  "Silva 2024 Assessing Misophonia in Young Adults Prevalence and Psychometric Validation of Misoquest.txt",
  "Guetta Rachel 2022 Examining Emotional Functioning in Misophonia.txt",
  "Jastreboff 2023 The neurophysiological approach to misophonia theory and treatment.txt",
  "Siepsiak  2019 Misophonia A Review of Research Results and Theoretical Concepts.txt",
  "Dixon 2023 Public Awareness of Misophonia in US adults a Population based study.txt",
  "Savard Marie-Anick Specificity of Affective Response Depends on Trigger Identification.txt",
  "lin 2024-brain-circuits-in-autonomous-sensory-meridian-response-and-related-phenomena.txt",
  "Cobbaert 2023 Eating Disorders and Neurodivergence A Stepped Care Approach.txt",
  "Aazh 2023 The Effectiveness of Unguided Internet-Based Cognitive Behavioral Therapy for Tinnitus and Misophonia.txt",
  "Smit 2023 A genome-wide association study of a rage-related misophonia symptom and the genetic link with audiological traits, psychiatric disorders, and personality.txt",
  "Jastreboff 2014 Treatments for Decreased Sound Tolerance Hyperacusis and misophonia.txt",
  "Fagelson 2022 Tinnitus and Traumatic Memory.txt",
  "Molapour 2021 Seven Computations of the social brain.txt",
  "Tziovara 2024 patients perception of sound and noise dimensions in the dental clinic environment.txt",
  "Johnson (1981) Reality monitoring.txt",
  "Chen Zhu 2022 How to Integrate the soundscape resource.txt",
  "Kumar 2023 Mimicry in Misophonia.txt",
  "Barahmand Ursha 2012 Implications of perceived physical and social aspects of the environment.txt",
  "Pan 2022 Treatment of Misophonia with Risperidone in a Patient with Autism Spectrum Disorder.txt",
  "Turnock 2022 Understanding Stigma in Autism.txt",
  "Vuoskoski 2024-the-aversive-musical-experience-scale-(ames)-measuring-individual-differences-in-the-intensity.txt",
  "Kaufman 2022 Opening a Door into the Riddle of Misophonia, Sensory over-responsiveness and pain.txt",
  "Mahady 2023 What is autonomous sensory meridian response ASMR A narrative revie and comparative analysis of related phenomena.txt",
  "Kula 2025 Hyperacusis and Misophonia Measures Dissertation.txt",
  "Schneider 2017 Case study A novel application of mindfulness and acceptance based.txt",
  "Rosenthal 2023 Treatment of Misophonia.txt",
  "Kula 2023 Hyperacusis and Misophonia a Systematic Review of Psychometric Measures.txt",
  "Du Plessis 2009Ethics of Knowledge UNESCO.txt",
  "Rosenthal 2022 phenotyping misophonia.txt",
  "Wang 2022 The tie that binds temporal coding adaptive emotion.txt",
  "Rosenthal 2022 Misophonia Symptoms Comorbidities and Perspectives of Intervention.txt",
  "Sabah 2024 UFHRD-2024-Abstract-Book (1).txt",
  "Berger et al 2025 human insula neurons respond to simple sounds during passive listening.txt",
  "Kazazis 2024 Triggering Misophonia  The Importance of Spectral Information  Temporal Information  and Action Identification.txt",
  "Wooley et al 2025 Recognizing Individual Variability in Misophonia Identifying Symptom Based Subgroups.txt",
  "McMahon 2024 The Unified protocol for transdiagnostic treatment of emotioanl disorders for misophonia.txt",
  "Johnson (1988) Reality monitoring an experimental phenomenological approach.txt",
  "Brandis Epistemology.txt",
  "Potgieter Iskra 2018 Misophonia A scoping Reiew of Research.txt",
  "Emilie_Schramer_poster.txt",
  "Kulik 1978 Frustration, Attribution of Blame, and Aggression.txt",
  "Colak et al 2021 Misophonic symptoms in non-psychotic psychiatric outpatients.txt",
  "Hansen 2021 Neural evidence for non-orofacial triggers in mild misophonia.txt",
  "Brennan 2023 Misophonia and Hearing Comorbidities.txt",
  "Jastreboff and Jastreboff (2002) Decreased Sound Tolerance and Tinnitus Retraining Therapy (TRT).txt",
  "Uglik-Marucha et al. (2023). Beyond sound irritation- cross-cultural evidence . . .  S-Five in a Polish sample. (2).txt",
  "Watson 2019 Prosody indexes both competence and performance.txt",
  "Papoulias 2021 material and epistemic precarity.txt",
  "Shafiq 2023 Hatred is a mindset triggered by stressful external events, negative personal.txt",
  "Tenesaca 2023 Neural_Correlates_of_Attention allocation versus sound habituation.txt",
  "Rappoldt et al 2-24 Psychometric Validation of the New Misophonia Screening List.txt",
  "Heller 2022 Identification of Everyday Sounds Affects Their Pleasantness.txt",
  "Ci Quek 2018 Misophonia in Singaporean Psychiatric Patients a Cross Sectional Study.txt",
  "LeDoux 2020 How does the nonconscious become conscious.txt",
  "Cassiello Robins 2020 A systematic review of Unified Protocol applications with adult populations.txt",
  "Scrutton 2017 Epistemic Injustice and Mental Illness.txt",
  "Abramovitch 2023 A neuropsychological study of misophonia.txt",
  "Monzel et al 2023 Aphantasia within the framework of neurodivergence.txt",
  "Murphy 2023 Alterations in attentinal processingin youth with misophonia.txt",
  "Henry 2022 Sound Tolerance Conditions Definitions and Clinical Management.txt",
  "Damis 2024 The role of implicit memory in the development and recovery from trauma.txt",
  "Dibb 2022 A Longitudinal investigation of quality of life and negative emotions in misophonia.txt",
  "Aryal 2023 Understanding Misophonia from an Audiological Perspective a Systematic Review.txt",
  "Smith 2022 Perceptions of Various Treatment Methodologies for Adults and Children with Misophonia.txt",
  "Wickie et al 2025 Social success in a noisy world.txt",
  "Shandiz et al 2025 The effectiveness of cathodal (tDCS) in right insula region and cognitive behavioral therapy in misophonia disorder.txt",
  "Translation Needed JSREP_Volume 44_Issue 205_Pages 523-612 (1).txt",
  "Papoulias 2021 material and epistemic precarity it_s time to talk about labour exploitation in mental health research.txt",
  "Radoilska 2020 distinguishing value neutrality.txt",
  "Samermit 2019 Cross Sensory Stimuli Modulate Reactions to Aversive Sounds.txt",
  "Neacsiu 2022 The neurobiology of misophonia and implications for novel, neuroscience driven interventions.txt",
  "Sakaraya 2022 Validity and Reliability Testing Study of the Turkish version of the misophonia scale.txt",
  "Schubert 2023 Making Up Misophonic People.txt",
  "Gowda 2023 Abstract A New Insomnia Phenotype Coronasomnia Misophonia Syndrome.txt",
  "Swanepoel 2017 how-evolutionary-thinking-can-help-us-to-understand-adhd.txt",
  "Cerliani 2020 Increased orbitofrontal connectivity in misophonia.txt",
  "Bowers et al 2014 Acceptance and commitment therapy versus progressive relaxation training for misophonia.txt",
  "Aryal 2024 Efferent Pathway Functioning.txt",
  "Schechter 2022 The unity of consciousness subjects and objectivity.txt",
  "Aldakhil and Shaik 2025 Misophonia in Autism A Systematic Review of prevalence, clinical features, and comorbidities.txt",
  "Jager 2020 Misophonia Phenomenology Comorbidity and demographics in a large sample.txt",
  "Madappally 2024 Do INdividuals with misophonia experience challenges with their auditory binaural interaction.txt",
  "Psychiatry Clin NeurosciSmith 2020 Recent advances in the application of predictive coding and active inference.txt",
  "Long 2018 Bottom up and top down factors differentially influence stimuls representations across large scale attentional networks.txt",
  "Chan 2023 The impact of mental health symptoms in children with Tinnitus and misophonia.txt",
  "Mufreze 2025 Beyond the Sound the role of the source.txt",
  "Jastreboff 2015 decreased sound tolerance hyperacusis, misophonia, diplacousis and polyacousis.txt",
  "Holohan 2023 Misophonia A Review of the Literature and Its Implications for the Social Work Profession.txt",
  "Ila 2023 Assessment of temporal auditory processing in individuals with misophonia.txt",
  "Ferrer-Torres 2022 On the lack of self-concept and social representation.txt",
  "Ozuer 2025 Understanding the misophonic experience a mixed method study.txt",
  "Savard 2025 Toward Cognitive Models of Misophonia.txt",
  "Sujeeth 2023 Estimation of Prevalence of Misophonia among High School students in India.txt",
  "Emotional Engagement to Music is Correlated with Enhanced Frisson.txt",
  "Sommerfeld 1989 The origins of Mother Blaming Historical Perspectives on Childhood and Mothering.txt",
  "Dibb and Golding 2023 Corrigendum A Longitudinal Investigation of quality of life and negative emotions in misophonia.txt",
  "Shan 2022 Misophobia handbook-comorbidity.txt",
  "Williams_2024_Dissertation_poster_Updated.txt",
  "Vitoratou 2020 Selective Sound Sensitivity Syndrome Scale S5.txt",
  "Clark and Chalmers (1998) The-Extended-Mind.txt",
  "Dozier 2015 Counterconditioning Treatment for Misophonia.txt",
  "BABCP Conference Abstract 2022.txt",
  "Casiello Robbins 2020 The Mediating Role of Emotion Regulation Within the Relationship Between Neuroticism and Misophonia A Preliminary Investigation.txt",
  "Williams 2022 Psychometric validation of a brief self report measure of misophonia symptoms and functional impairment The duke-vanderbilt misophonia screening questionnaire.txt",
  "Oh Et al 2025 Physiological Responses to Aversive and Non-aversive Audiovisual, Audio and Visual Stimuli.txt",
  "Rouw and Erfanian 2017 A Large Scale Study of Misophonia.txt",
  "Taschereau dash Domouchel 2021 Putting the mental back.txt",
  "Allen 2017 Aggression and Violence Definitions and distinctions.txt",
  "Yang et al. 2024 Impaired motor to sensory transformation mediates auditory hallucinations.txt",
  "Shimokura 2022 Sound Quality Factors Inducing the Autonomous Sensory Meridian Response.txt",
  "Guzick 2023 Clincial characteristics.txt",
  "Hume 2022 Physiological responses to and subjective estimates of soundscape elements.txt",
  "Zhang 2021 Individualism and nationally determined contributions to climate change.txt",
  "Wang 2022 Emotion Processes Predicting Outbursts and Functional Impact in Misophonia.txt",
  "Ruano 2025 From Misophonia through Puberphonia.txt",
  "Uglik-Marucha et al. (2023) Beyond sound irritation.txt",
  "BARAHMAND  2023 New York Misophonia Scale.txt",
  "Carter and Ellis 2025 Control  Resistance  and the Senses  Neurodivergent Perspectives of the UK School Meals Service  A Case Study.txt",
  "thieren-et-al-2Thieren 2024-new-hyperacusis-therapy-combines-psychoeducation-sound-exposure-and-counseling.txt",
  "Samermit 2022 Development and Evaluation of a Sound-Swapped Video Database for Misophonia.txt",
  "Shin 2022 Clinical findings that differentiate co-occurence of hyperacusis from tinnitus.txt",
  "Pfeiffer Elisa 2022 Misophonia in Children and Adolescents.txt",
  "Babalola 2024 Misophonia is associated with heightened emtion evocation by music PsyArXiv.txt",
  "Adnan 2023 Sensing Sound on the Skin a review of auitory tactile synesthesia.txt",
  "Turnhout 2020 the politics of coproduction participation, power, and transformation.txt",
  "Golonka 2025 Sensory processing sensitivity in adult dental patients.txt",
  "Meek 2023 Dissertation Sensory Processing.txt",
  "Bolton and Gillett 2019 The Biopsychosocial model of health and disease.txt",
  "Zumbrunn 2023 Investigating Sound Specific Attention Control.txt",
  "Ghorbani 2022 Effectiveness of online group mindfulness and acceptance based therapy.txt",
  "Williams 2022 Decreased sound Tolerance in autism understanding and distinguishing between hyperacusis, misophonia, and phonophobia.txt",
  "Muller 2018 Cognitive_Behavioral_Therapy_for_an_Adolescent Female Presesnting with Misophonia.txt",
  "Gladney 2024 Evaluation and Treatment of Central Auditory Processing and Sound.txt",
  "Pack 2019 The need for an ethics of sustainable knowledge production.txt",
  "Peer Review Comments Curation of Foams.txt",
  "Swedo et al. 2023 Consensus Defintion.txt",
  "Kim 2023 Speech in Noise performance in individuals with misophonia and hyperacusis.txt",
  "Brown 2014 Consciousness doesn_t overflow cognition.txt",
  "Rinaldi 2023 Mental Health Difficulties in Children who Develop Misophonia.txt",
  "Banker 2024 Neural and behavioral coputations of social interaction in autism and beyond.txt",
  "Manning  2025 Decreased Sound tolerance in a Canadian University Context.txt",
  "Casiello Robbins 2021  A Preliminary Investigation of the Association Between Misophonia and Symptoms of Psychopathology and Personality Disorders.txt",
  "simner 2024-an-automated-online-measure-for-misophonia-the-sussex-misophonia-scale-for-adults.txt",
  "Eijsker 2021 White Matter Abnormalities in misophonia.txt",
  "Bennett 2023 diagnostic uncertainty avoidant restrictive food intake disorder.txt",
  "Hansen 2021 What Sound sources trigger misophonia not just chewing and breathing.txt",
  "Bell 2020 Ethics, politics and embodied imagination in crafting scientific knowledge.txt",
  "Banker 2022 Disrupted computations of social control in individuals with obsessive-compulsive and misophonia symptoms.txt",
  "Palumbo 2018 Misophonia and Potential Underlying Mechanisms A Perspective.txt",
  "Aldine 2024 Assessment of working memory abilities people with and without misophonia.txt",
  "Rabani 2023 Detecting suicidality on social media machine learning at rescue.txt",
  "Mahmoud Dissertation 2024.txt",
  "Molenda 2024 Thought Contagion Conspiracy Beliefs Boost Paranoid Thoughts.txt",
  "Ash 2023 Mimicry in misophonia a large scale survey of prevalance and relationship with trigger sounds.txt",
  "Spencer 2023 Things that Make you go Hmmm Myths and misconceptions within cognitive behavioral treatment of obsessive compulsive disorder.txt",
  "Lodol 2024 Analyzing Sensory Gating MA Thesis.txt",
  "Tollefsrud 2020 Obsessed with Sound an investigation into misophonia and its relation to memory.txt",
  "Simmons (1997) Brain Mechanisms of Reality Monitoring.txt",
  "Pereira 2020 The role of sentience in the theory of consciousness.txt",
  "Lewin 2023 Clinical Characteristics of treatment seeking youth with misophonia.txt",
  "Mollman 2023 The central role of symptom severity and associated characteristics for functional impairment in misophonia.txt",
  "Guzick and Storch 2025 Chapter Six Sensory Dysregulation in OCD-Related Disorders.txt",
  "Schneebeli 2022 Disentanging Bayesian Brain theories of autism spectrum disorder.txt",
  "McGeoch 2020 How everyday sounds can trigger strong emotions ASMR, misophonia and the feeling of wellbeing.txt",
  "Peltola Henna-Riikka 2022 The Kind of Music that Makes my Skin Crawl.txt",
  "Langlo (2022) I Don_t think people really understand the seriousness.txt",
  "Black et al 2025 Misophonia symptoms severity is attributed to impaired flexibility and heightened rumination.txt",
  "Mashour 2020 Conscious Processing and the Global Neuronal Workspace Hypothesis.txt",
  "Bruxner 2016 Mastication Rage a review of misophonia.txt",
  "Silva page 68 0-Livro de Atas_CLTO_RACS_completo (1).txt",
  "Brout 2018 Investigating Misophonia A Review of the Emperical Literature, Clinical Implications, and a Research Agenda.txt",
  "Henry 2023 History of Tinnitus at VA.txt",
  "Rosenthal 2022 Treatment of Misophonia.txt",
  "Mecca Andrew 2022 cAMP and voltage modulate rat auditory mechanostransduction.txt",
  "Bodo 2024 Association between chronic misophonia-induced stress and gastrointestinel pathology in children.txt",
  "Mitova 2020 Explanatory Injustice and Epistemic Agency.txt",
  "Bahmei 2023 Misophonia Sound Recognition Using Vision Transformer.txt",
  "Mutlu 2023 Misophonia and its relationship with other psychiatric disorders.txt",
  "D Antoni 2021 Brainspotting reduces disturbance and increases heart rate variability linked to distressing memories.txt",
  "Cervin 2023 Measuring Misophonia in Youth.txt",
  "Colak 2021 Misophonic symptoms in non-psychotic psychiatric outpatients.txt",
  "Singer 2024 Undergraduate Honors Thesis An Exploration of Misophonia in the Literature.txt",
  "Wybrane-problemy-wspolczesnej-diagnostyki-klinicznej_2024.txt",
  "Hostler 2024 Research Priorities for Autonomous Sensory Meridian.txt",
  "Schroder 2014 Diminished N1 auditory.txt",
  "Dwyer et al 2025 A trans-diagnostic investigation of attention and diverse phenotypes of auditory hyperreactivity.txt",
  "Guetta 2022 Development and psychometric exploration of a semi-structured clinical interview for misophonia.txt",
  "Seth 2022 Theories of Consciousness.txt",
  "Mednicoff 2022 Auditory affective processing, musicaliyt, and the development of misophonic reactions.txt",
  "Pfeiffer 2023 The prevalence of misophonia in a representative population based survey in Germany.txt",
  "Jean Pamelo 2022 ACES a Test I wanted a low score on.txt",
  "Jastreboff 2018 Tinnitus and decreased sound tolerance.txt",
  "Almadani 2024 Prevalence_of_misophonia_and_its_association_with depression and OCD among medical students.txt",
  "Balachandar 2025 Misophonia in Tic Disorders and Their Neuropsychiatric Associations.txt",
  "Izmaylov 2022 Insight Essay.txt",
  "Remmert 2022 A Nomological Network for Misophonia.txt",
  "Vanukuri 2023 Misophonia Assessment on Individuals with various occupations.txt",
  "Hansen 2024 The Effect of Misophonia on Coginitive and Social justgements.txt",
  "Cuthbert 2015 Research Domain Criteria toward future psychiatric nosologies.txt",
  "Sheppard 2020 Right hemisphere ventral stream for emotional prosody identification.txt",
  "Enzler Falco 2021 A psychoacoustic test for misophonia.txt",
  "Chapman 2022 Reimagining the mental health paradigm for our collective well being.txt",
  "Brout 2022 A Brief Commentary on the Conesnsus Defintion.txt",
  "Mitchell 2024 State of the Science Disgust and the Anxiety Disorders.txt",
  "Schadegg Mary 2021 Evaluating Anxiety Sensitivity.txt",
  "Ash 2023  Dr Jekyll Had Misophonia_Preprint.txt",
  "Aazh 2022 Audiological and Other Factors Predicting the Presence of Misophonia Symptoms Among a Clinical Population Seeking Help for Tinnitus and or Hyperacusis.txt",
  "Webb and Keane 2022 MDMA for the treatment of misophonia a proposal.txt",
  "Rinaldi Louisa 2022 Poorer Well Being in Children with Misophoia Sussex Scale 2022.txt",
  "Gillmeister Helge 2022 Touching You Touching Me.txt",
  "Herdi and Yildirim 2024 Sex Specific Correlations Between Misophonia Symptoms and ADHD, OCD, and Autism Related Traits in Adolescent Outpatients.txt",
  "Almoril-Porrras et al 2025 Configuration of electrical synapses filters sensory information to drive behavior choices.txt",
  "Jaswal  and Handy 2024 is misokinesia explained by visual attentional orienting.txt",
  "Naylor 2021 The Prevalence adn Severity of Misophonia in a UK Undergraduate Medical Student population.txt",
  "Kula 2025 Evaluation of the psychometric properties of the English MisoQuest and its relationship with audiological and psychological factors.txt",
  "Robinson 2023 The lived experiences of people with misophonia v2 - Revised_SS.txt",
  "Prats 2024 Implementing the Reconsolidation Paradigm in Treating Misophonia.txt",
  "Kim 2023 The Effects of Autonomous Sensory Meridian Response on MOdality Mood and Mindfulness.txt",
  "Iskander   2023  Neurological_Underpinnings_of_Psychological Factors.txt",
  "Andermane 2023 A Phenomenological Cartography of Misophonia.txt",
  "Gupta 2024 Self and Else Living on the Receiving Ends of Misophonia.txt",
  "Storch 2023 Family Accommodations in Children and Adolescents with  Misophonia.txt",
  "Balan 2021 The Networked Computer Metaphor a Novel Tool for Psychiatric Trainees.txt",
  "poerio 2024-sensing-and-feeling-an-overview.txt",
  "Pohlhaus 2014 Discerning the Primary Epistemic Harm in Cases of Testimonial Injustice.txt",
  "Rabinow 1994 Foucault_Michel_Ethics_Subjectivity_and_Truth.txt",
  "Castillo-et-al-2024-psychometric-properties-of-a-self-perception-questionnaire-for-adults-with-suspected-misophonia.txt",
  "Lyre 2018 Socially Extended Cognition and Shared Intentionality.txt",
  "Larsen 2022 Preliminary validation of the Norwegian version of misophonia questionnaire MQ NOR.txt",
  "Vitoratou 2022 Evidence of Cross-Cultural Consistency of the S-Five Model for Misophonia Psychometric Conclusions Emerging From the Mandarin Version.txt",
  "Woolley Clinical characteristics of a treatment seeking sample of adults with misophonia.txt",
  "Bishop 2007 Foucauldian_Diagnostics_Space_Time_and_t.txt",
  "Vitoratou 2023 Misophonia in the UK Prevalence and norms from the S Five in a UK representative sample.txt",
  "Lane 2023 Tracing the Song of the Universe A Jungian Investigation of the Archetypal Aspects of Sound.txt",
  "Elden 2023 Foucault Before the College de France.txt",
  "Fayzullina 2016 23andMe White Paper.txt",
  "Bain 2024 A tutorial on supervised machine learning variable selection.txt",
  "Syed 2020 The role of the biopsychosocial model in public health.txt",
  "Oberman et al 2025 Human sounds and associated tonality disrupting.txt",
  "NISVSReportonIntimatePartnerViolence_2022.txt",
  "Frost and Lumia 2012 The Ethics of Neuroscience and the Neuroscience of Ethics.txt",
  "Adolphs 2010 Conceptual Challenges and Directions for Social Neuroscience.txt",
  "Michel 2019 consciousness science underdetermined a short history.txt",
  "Pollock 2007 The Performative I.txt",
  "Williams 2021 A Review of Decreased sound tolerance in Autism Defiitions, phenomenology, and potential mechanisms.txt",
  "Ciaunica A 2021 Back to Square One bodily role of consciousness.txt",
  "Dixon 2024 Prevalence, Phenomenology, and Impact of Misophonia.txt",
  "Brake 2024 My struggles are largely sensory.txt",
  "LeDoux 2020 Thoughtful Feelings.txt",
  "McMahon 2024 The unified protocol for transdiagnostic treatment of emotional disorders.txt",
  "Radoilska 2017  Circumstance, Answerabilitiy, and Luck.txt"
]


================================================================================


################################################################################
# File: scripts/optimized_batch_process_gian_v1.py
################################################################################

# File: scripts/optimized_batch_process_gian_v1.py

#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────────────
# ──────────────────────────────────────────────────────────────────────────────
"""
Batch‑upload pre‑parsed research papers into Supabase
using a fixed‑token sliding window (768 tokens, 20 % overlap).

INPUT  directories
──────────────────
documents/research/json   one JSON per paper (metadata + per‑page text)
documents/research/txt    flat .txt version (kept for future re‑chunking)

DB schema expected
──────────────────
  research_documents  (one row per paper)
  research_chunks     (token_window strategy)

Chunking parameters
───────────────────
  • window      768 tokens
  • overlap     154 tokens   (20 %)
  • step        614 tokens   (window − overlap)

Sentence‑friendly rule
──────────────────────
After *window* tokens are gathered we keep adding UNTIL the next token
ends with `.`, `!`, or `?` —or the file ends, or we exceed
window + 256 tokens.  This avoids mid‑sentence splits whenever possible.
"""
from __future__ import annotations

import argparse
import json
import os
import random
import re
import sys
import time
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Sequence

from dotenv import load_dotenv
from supabase import create_client
from tqdm import tqdm

# ───────────────────────────── env / constants ────────────────────────────── #

load_dotenv()

REPO_ROOT      = Path(__file__).resolve().parent.parent
JSON_DIR       = REPO_ROOT / "documents" / "research" / "json"
TXT_DIR        = REPO_ROOT / "documents" / "research" / "txt"   # kept but unused here

SUPABASE_URL   = os.getenv("SUPABASE_URL")
SUPABASE_KEY   = os.getenv("SUPABASE_SERVICE_ROLE_KEY")

DEFAULT_WINDOW   = 768
DEFAULT_OVERLAP  = int(DEFAULT_WINDOW * 0.20)     # 154
DEFAULT_STEP     = DEFAULT_WINDOW - DEFAULT_OVERLAP
SENT_END_RE      = re.compile(r"[.!?]$")

# ─────────────────────────── NUL‑byte scrubber ───────────────────────────── #

def scrub_nuls(obj: Any) -> Any:
    """Recursively remove ASCII‑NUL characters from any str inside *obj*."""
    if isinstance(obj, str):
        return obj.replace("\x00", "")
    if isinstance(obj, list):
        return [scrub_nuls(x) for x in obj]
    if isinstance(obj, dict):
        return {k: scrub_nuls(v) for k, v in obj.items()}
    return obj

# ───────────────────────────────── helpers ────────────────────────────────── #

def discover_json_files() -> List[Path]:
    return sorted(JSON_DIR.rglob("*.json"))

def load_paper(json_path: Path) -> Dict[str, Any]:
    return json.loads(json_path.read_text(encoding="utf‑8"))

def concat_sections(sections: Sequence[Dict[str, Any]]) -> tuple[list[str], list[int]]:
    """
    Return (tokens, token_to_page)  ↦  token_to_page[i] = 1‑based page number.
    """
    tokens: list[str] = []
    page_map: list[int] = []
    for sec in sections:
        page = sec.get("page_number") or 1
        sec_tokens = sec.get("text", "").split()
        tokens.extend(sec_tokens)
        page_map.extend([page] * len(sec_tokens))
    return tokens, page_map

def sliding_window_chunks(
    tokens: List[str],
    page_map: List[int],
    *,
    window: int = DEFAULT_WINDOW,
    overlap: int = DEFAULT_OVERLAP,
) -> List[Dict[str, Any]]:
    """Fixed‑token windows with overlap, but avoid cutting sentences."""
    step = max(1, window - overlap)
    chunks: list[dict[str, Any]] = []
    i = 0
    safety_extra = 256

    while i < len(tokens):
        start = i
        end   = min(len(tokens), start + window)

        # extend to sentence boundary if possible
        while (
            end < len(tokens)
            and not SENT_END_RE.search(tokens[end - 1])
            and (end - start) < window + safety_extra
        ):
            end += 1

        text_slice  = " ".join(tokens[start:end])
        page_start  = page_map[start]
        page_end    = page_map[end - 1]
        chunk_idx   = len(chunks)

        chunks.append(
            {
                "chunk_index":  chunk_idx,
                "token_start":  start,
                "token_end":    end - 1,
                "page_start":   page_start,
                "page_end":     page_end,
                "text":         scrub_nuls(text_slice),
            }
        )
        if end == len(tokens):
            break
        i += step

    return chunks

# ────────────────────────────── Supabase I/O ─────────────────────────────── #

def get_processed_pdfs(sb) -> set[str]:
    """
    Return the set of source_pdf paths already present in research_documents.
    """
    try:
        rows = sb.table("research_documents").select("source_pdf").execute().data or []
        return {row["source_pdf"] for row in rows}
    except Exception as e:
        print(f"[get_processed_pdfs] {e}")
        return set()

BIB_KEYS = {
    "doc_type", "title", "authors", "year",
    "journal", "doi", "abstract", "keywords",
    "research_topics", "source_pdf",
}

def insert_document(sb, raw_meta: Dict[str, Any]) -> str:
    """
    Insert into research_documents; returns UUID.  Re‑use row if DOI matches.
    """
    raw_meta = scrub_nuls(raw_meta)
    doi = raw_meta.get("doi")

    # ── 1.  reuse if DOI already there
    if doi:
        q = (
            sb.table("research_documents")
            .select("id")
            .eq("doi", doi)
            .limit(1)
            .execute()
        )
        if q.data:
            return q.data[0]["id"]

    # ── 2.  trim to bibliographic subset
    meta_small = {k: raw_meta.get(k) for k in BIB_KEYS}

    payload = {
        **meta_small,
        # defaults / housekeeping
        "doc_type":   meta_small.get("doc_type", "scientific paper"),
        "authors":    meta_small.get("authors") or [],
        "keywords":   meta_small.get("keywords") or [],
        "research_topics": meta_small.get("research_topics") or [],
        "metadata":   meta_small,                 # stored as jsonb
        "created_at": datetime.utcnow().isoformat(),
    }
    res = sb.table("research_documents").insert(payload).execute()
    if getattr(res, "error", None):
        raise RuntimeError(res.error)
    return res.data[0]["id"]

def insert_chunks(sb, doc_id: str, json_path: Path, chunks: Sequence[Dict[str, Any]]):
    max_batch = 500
    rows = [
        {
            "document_id":       doc_id,
            "chunk_index":       ch["chunk_index"],
            "token_start":       ch["token_start"],
            "token_end":         ch["token_end"],
            "page_start":        ch["page_start"],
            "page_end":          ch["page_end"],
            "text":              ch["text"],
            "metadata":          json.loads(json.dumps({}).replace('\u0000', '')),  # extra per‑chunk data (now clean)
            "chunking_strategy": "token_window",
            "source_file":       json_path.as_posix(),  # ← renamed column
            "created_at":        datetime.utcnow().isoformat(),
        }
        for ch in chunks
    ]
    for i in range(0, len(rows), max_batch):
        sb.table("research_chunks").insert(rows[i : i + max_batch]).execute()

# ─────────────────────────────── main process ────────────────────────────── #

def process_one_paper(
    sb,
    json_path: Path,
    *,
    window: int,
    overlap: int,
) -> tuple[bool, str]:
    try:
        paper = load_paper(json_path)
        sections = paper.get("sections") or []
        if not sections:
            return False, "No sections/text found."

        tokens, page_map = concat_sections(sections)
        if not tokens:
            return False, "Empty token list."

        chunks = sliding_window_chunks(tokens, page_map, window=window, overlap=overlap)
        doc_id = insert_document(sb, paper)
        insert_chunks(sb, doc_id, json_path, chunks)
        return True, f"{len(chunks)} chunks"
    except Exception as e:
        return False, str(e)

# ─────────────────────────────────── CLI ─────────────────────────────────── #

def main() -> None:
    p = argparse.ArgumentParser(description="Upload 768‑token window chunks to Supabase")
    p.add_argument("--batch-size", type=int, default=20, help="papers per run (0 = all)")
    p.add_argument("--window",     type=int, default=DEFAULT_WINDOW, help="tokens per chunk")
    p.add_argument("--overlap",    type=int, default=DEFAULT_OVERLAP, help="token overlap")
    p.add_argument("--selection",  choices=["sequential", "random"], default="sequential")
    args = p.parse_args()

    if not (SUPABASE_URL and SUPABASE_KEY):
        sys.exit("❌  Missing SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY")

    sb = create_client(SUPABASE_URL, SUPABASE_KEY)

    all_json = discover_json_files()
    processed_pdfs = get_processed_pdfs(sb)
    remaining = [
        p for p in all_json
        if scrub_nuls(load_paper(p)).get("source_pdf") not in processed_pdfs
    ]

    if args.selection == "random" and args.batch_size and len(remaining) > args.batch_size:
        remaining = random.sample(remaining, args.batch_size)
    elif args.batch_size:
        remaining = remaining[: args.batch_size]

    if not remaining:
        print("✨  Nothing new to process.")
        return

    step = args.window - args.overlap
    print(f"Uploading {len(remaining)} papers …  (window={args.window}, overlap={args.overlap}, step={step})")
    ok = fail = 0
    for jp in tqdm(remaining, desc="Papers"):
        success, msg = process_one_paper(
            sb,
            jp,
            window=args.window,
            overlap=args.overlap,
        )
        if success:
            ok += 1
        else:
            fail += 1
            print(f"  ! {jp.name} → {msg}")

    print(f"\nDone ✔   success={ok}   failed={fail}")

if __name__ == "__main__":
    main()


================================================================================


################################################################################
# File: src/TermsModal.jsx
################################################################################

import React, { useState } from 'react';

export default function TermsModal({ onAccept }) {
  const [checked, setChecked] = useState(false);
  return (
    <div style={{ position:'fixed', top:0, left:0, right:0, bottom:0, backgroundColor:'rgba(0,0,0,0.7)', zIndex:1000, display:'flex', alignItems:'center', justifyContent:'center', border:'4px dashed red' }}>
      <div style={{ background:'#fff', padding:'2rem', maxWidth:'600px', width:'80%', boxSizing:'border-box', maxHeight:'80vh', overflowY:'auto', borderRadius:'8px', display:'flex', flexDirection:'column', alignItems:'center', border:'4px solid blue' }}>
        <h2>Terms and Conditions</h2>
        <div style={{ overflowY:'auto', maxHeight:'50vh', textAlign:'left', width:'100%' }}>
          <p><strong>Effective Date:</strong> [Insert Date]</p>
          <p><strong>1. Acceptance of Terms</strong> By accessing or using the Misophonia Companion application ('App'), you agree to be bound by these Terms and Conditions ('Terms'). If you do not agree to these Terms, do not use the App.</p>
          <p><strong>2. Nature of the App</strong> Misophonia Companion is a digital wellness and research guide. It is intended for informational, educational, and personal support purposes only. The App does not provide medical advice, diagnosis, or treatment. It is not a licensed healthcare service and is not intended to replace professional consultation.</p>
          <p><strong>3. Eligibility</strong> You must be at least 16 years old to use the App. If you are under 18, you confirm that you have received parental or guardian consent.</p>
          <p><strong>4. Privacy and Data</strong> We respect your privacy. Our Privacy Policy explains how we collect, use, and protect your information. By using the App, you agree to the terms of our Privacy Policy.</p>
          <p>No health information (as defined under HIPAA) is collected without explicit consent.</p>
          <p>Conversations may be stored anonymously for product improvement unless you opt out.</p>
          <p>We do not sell or share your data with third parties for advertising purposes.</p>
          <p><strong>5. User Conduct</strong> You agree to use the App responsibly and not to misuse the services, including but not limited to:</p>
          <ul>
            <li>Attempting to reverse-engineer, copy, or modify the App</li>
            <li>Submitting harmful, abusive, or misleading content</li>
            <li>Interfering with the operation or integrity of the App</li>
          </ul>
          <p><strong>6. Limitation of Liability</strong> To the fullest extent permitted by law, Misophonia Companion and its creators are not liable for any direct, indirect, incidental, or consequential damages resulting from the use—or inability to use—the App. This includes, but is not limited to, psychological distress, loss of data, or misinterpretation of information.</p>
          <p><strong>7. Modifications to the Terms</strong> We reserve the right to modify these Terms at any time. Continued use of the App after changes means you accept the new Terms.</p>
          <p><strong>8. Termination</strong> We may suspend or terminate access to the App at our discretion, without notice, for conduct that violates these Terms.</p>
          <p><strong>9. Governing Law</strong> These Terms are governed by the laws of the state of [Your State], without regard to conflict of laws principles.</p>
          <p><strong>10. Contact</strong> For questions or concerns about these Terms, please email: [Your Contact Email]</p>
        </div>
        <h2>Privacy Policy</h2>
        <div style={{ overflowY:'auto', maxHeight:'30vh', textAlign:'left', width:'100%' }}>
          <p><strong>Effective Date:</strong> [Insert Date]</p>
          <p><strong>1. Introduction</strong> This Privacy Policy describes how Misophonia Companion ('we', 'us', 'our') collects, uses, and protects your personal information when you use our web and mobile application ('App').</p>
          <p><strong>2. Information We Collect</strong></p>
          <p><strong>•</strong> <em>User-Provided Information</em>: When you create an account or interact with the App, you may provide personal information such as your email address and preferences.</p>
          <p><strong>•</strong> <em>Anonymous Usage Data</em>: We may collect anonymized data on app usage, interactions, and conversation content to improve the experience.</p>
          <p><strong>•</strong> <em>Optional Personal Logs</em>: Users may opt in to mood tracking, journaling, or trigger tagging. This data is stored securely and only accessible to the user unless explicitly shared.</p>
          <p><strong>3. How We Use Your Information</strong> To provide and improve our services; to personalize your user experience; for anonymized research and development; to comply with legal obligations if required.</p>
          <p><strong>4. Data Storage and Security</strong> We use secure, encrypted servers and industry-standard protocols to store your data. Sensitive data is never shared with third parties without consent. You may request deletion of your account and data at any time.</p>
          <p><strong>5. Sharing and Disclosure</strong> We do not sell or rent your personal information. We may share anonymized data with research collaborators or analytics partners. We may disclose information if legally compelled (e.g., court order).</p>
          <p><strong>6. Your Rights and Choices</strong> You may update or delete your personal information from your profile. You may opt out of data collection for research purposes. You may contact us for a copy of any personal data we’ve stored.</p>
          <p><strong>7. Children’s Privacy</strong> Our App is not intended for children under 16. We do not knowingly collect data from individuals under this age without parental consent.</p>
          <p><strong>8. Changes to This Policy</strong> We may revise this policy from time to time. Users will be notified of significant changes. Continued use of the App indicates acceptance of the updated policy.</p>
          <p><strong>9. Contact Us</strong> If you have questions or requests related to this Privacy Policy, please contact us at: [Your Contact Email]</p>
        </div>
        <label style={{ display:'block', margin:'1rem 0', textAlign:'center', width:'100%' }}>
          <input type='checkbox' checked={checked} onChange={e => setChecked(e.target.checked)} /> I have read and agree to the Terms and Conditions and Privacy Policy
        </label>
        <button disabled={!checked} onClick={() => { localStorage.setItem('termsAccepted','true'); onAccept(); }} style={{ marginTop:'1.5rem', padding:'0.5rem 1rem' }}>Continue</button>
      </div>
    </div>
  );
}


================================================================================


################################################################################
# File: netlify/functions/research.js
################################################################################

// File: netlify/functions/research.js

/**
 * Topic-aware “Research Assistant”
 * Supports OpenAI **or** Gemini depending on AI_PROVIDER env var.
 *
 * POST /.netlify/functions/research
 * Body: { messages:[…], topic?:string }
 *
 * ENV:
 *   AI_PROVIDER          openai | gemini      (default openai)
 *   OPENAI_API_KEY       required if provider=openai
 *   GEMINI_API_KEY       required if provider=gemini
 */

import 'dotenv/config';
import { OpenAI } from 'openai';

// ─────────────────────────────────────────────────────────────
const AI_PROVIDER = (process.env.AI_PROVIDER ?? 'openai').toLowerCase();
// ─────────────────────────────────────────────────────────────

/* -----------------------------------------------------------
 * Common helpers
 * --------------------------------------------------------- */
function badRequest(msg) {
  return {
    statusCode: 400,
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ error: msg }),
  };
}

function serverError(msg, details) {
  if (details) console.error(details);
  return {
    statusCode: 500,
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ error: msg }),
  };
}

/* ===========================================================
 *  OpenAI branch
 * ========================================================= */
async function openaiHandler(messages, topic) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) return serverError('OPENAI_API_KEY missing');

  const openai = new OpenAI({ apiKey });

  const systemPrompt = topic
    ? `You are a knowledgeable research assistant focusing on “${topic}”. Provide accurate, concise information about misophonia research.`
    : 'You are a knowledgeable research assistant on misophonia research.';

  const oaMessages = [
    { role: 'system', content: systemPrompt },
    ...messages,
  ];

  const completion = await openai.chat.completions.create({
    model: 'gpt-4o',
    messages: oaMessages,
    max_tokens: 1024,
    temperature: 0.7,
  });

  return {
    statusCode: 200,
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({
      reply: completion.choices?.[0]?.message?.content ?? '',
      structured: null,
      provider: 'openai',
    }),
  };
}

/* ===========================================================
 *  Gemini branch
 * ========================================================= */
async function geminiHandler(messages, topic) {
  const apiKey = process.env.GEMINI_API_KEY;
  if (!apiKey) return serverError('GEMINI_API_KEY missing');

  // Build user prompt
  let userPrompt = '';
  if (topic) userPrompt += `Topic: ${topic}\n`;
  userPrompt += messages
    .map(
      (m) => `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`
    )
    .join('\n');

  const resp = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro-preview-03-25:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        contents: [{ role: 'user', parts: [{ text: userPrompt }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 1024 },
        tools: [
          {
            function_declarations: [
              {
                name: 'structured_output',
                description:
                  'Return information in a structured JSON format for chat display, with sections, bullet points, and highlights.',
              },
            ],
          },
        ],
      }),
    }
  );

  if (!resp.ok) {
    const errText = await resp.text().catch(() => '');
    return serverError('Error from Gemini API', errText);
  }

  const data = await resp.json();

  let structured = null;
  try {
    const part = data.candidates?.[0]?.content?.parts?.[0];
    if (part?.functionCall?.name === 'structured_output') {
      structured = JSON.parse(part.functionCall.args.json || '{}');
    }
  } catch {
    // swallow JSON parse errors – keep structured=null
  }

  const reply =
    data.candidates?.[0]?.content?.parts?.[0]?.text ?? '';

  return {
    statusCode: 200,
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ reply, structured, provider: 'gemini' }),
  };
}

/* ===========================================================
 *  Netlify Function entry-point
 * ========================================================= */
export async function handler(event /* , context */) {
  if (event.httpMethod !== 'POST') {
    return { statusCode: 405, body: 'Method Not Allowed' };
  }

  // ─── parse body ──────────────────────────────────────────
  let body;
  try {
    body = JSON.parse(event.body ?? '{}');
  } catch {
    return badRequest('Invalid JSON');
  }

  const { messages, topic } = body;
  if (!Array.isArray(messages) || messages.length === 0) {
    return badRequest('messages array required');
  }

  try {
    if (AI_PROVIDER === 'gemini') {
      return await geminiHandler(messages, topic);
    }
    // default → openai
    return await openaiHandler(messages, topic);
  } catch (err) {
    return serverError(
      `Unexpected ${AI_PROVIDER} handler failure`,
      err
    );
  }
}


================================================================================


################################################################################
# File: scripts/migrate_to_supabase.js
################################################################################

import fs from 'fs';
import path from 'path';
import admin from 'firebase-admin';
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

// Load environment variables
dotenv.config({ path: path.resolve(process.cwd(), 'server/.env') });

// Initialize Firebase Admin SDK (source)
const serviceAccount = {
  projectId: process.env.FIREBASE_PROJECT_ID,
  clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
  privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
};
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});
const db = admin.firestore();

// Initialize Supabase (destination)
const supabase = createClient(
  process.env.SUPABASE_URL || '',
  process.env.SUPABASE_ANON_KEY || ''
);

// Export Firestore data
async function exportFirestoreData() {
  console.log('Exporting data from Firestore...');
  
  const chunks = await db.collection('research_chunks').get();
  const data = chunks.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    // Convert Firestore timestamp to ISO string
    created_at: doc.data().createdAt?.toDate().toISOString()
  }));
  
  fs.writeFileSync('chunks_export.json', JSON.stringify(data));
  console.log(`Exported ${data.length} documents to chunks_export.json`);
  return data;
}

// Import to Supabase
async function importToSupabase(data) {
  console.log('Importing data to Supabase...');
  
  // Insert in batches
  const BATCH_SIZE = 500;
  for (let i = 0; i < data.length; i += BATCH_SIZE) {
    const batch = data.slice(i, i + BATCH_SIZE);
    
    console.log(`Importing batch ${Math.floor(i/BATCH_SIZE) + 1}/${Math.ceil(data.length/BATCH_SIZE)}...`);
    
    // Prepare records for Supabase
    const records = batch.map(item => {
      // Remove Firestore-specific fields and rename fields to match Supabase schema
      const { createdAt, embedding, ...rest } = item;
      return {
        ...rest,
        // Use created_at from previous conversion or current date
        created_at: item.created_at || new Date().toISOString()
      };
    });
    
    const { error } = await supabase
      .from('research_chunks')
      .insert(records);
    
    if (error) {
      console.error('Error importing batch:', error);
    } else {
      console.log(`Successfully imported batch ${Math.floor(i/BATCH_SIZE) + 1}`);
    }
  }
  
  console.log('Import completed!');
}

// Main function
async function main() {
  try {
    // Check if export file exists
    if (fs.existsSync('chunks_export.json')) {
      console.log('Using existing export file: chunks_export.json');
      const data = JSON.parse(fs.readFileSync('chunks_export.json'));
      await importToSupabase(data);
    } else {
      const data = await exportFirestoreData();
      await importToSupabase(data);
    }
  } catch (error) {
    console.error('Migration failed:', error);
  }
}

main().catch(console.error);


================================================================================


################################################################################
# File: netlify/functions/chat.js
################################################################################

// File: netlify/functions/chat.js

/**
 * Generic OpenAI chat endpoint
 * POST /.netlify/functions/chat
 * Body: { messages: [ { role:"user"|"assistant"|"system", content:"…" }, … ] }
 */
import 'dotenv/config';
import { OpenAI } from 'openai';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function handler(event /* , context */) {
  // ───────── guard HTTP method ──────────
  if (event.httpMethod !== 'POST') {
    return { statusCode: 405, body: 'Method Not Allowed' };
  }

  // ───────── parse body ──────────
  let body;
  try {
    body = JSON.parse(event.body ?? '{}');
  } catch {
    return { statusCode: 400, body: JSON.stringify({ error: 'Invalid JSON' }) };
  }

  const { messages } = body;
  if (!Array.isArray(messages) || messages.length === 0) {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'messages array required' }),
    };
  }

  // ───────── OpenAI call ──────────
  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages,
      max_tokens: 512,
      temperature: 0.7,
    });

    const reply =
      completion.choices?.[0]?.message?.content ?? '⚠️ no response';

    return {
      statusCode: 200,
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ reply }),
    };
  } catch (err) {
    console.error('OpenAI error →', err);
    return {
      statusCode: 500,
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ error: 'Error from OpenAI API' }),
    };
  }
}


================================================================================


################################################################################
# File: src/index.css
################################################################################

:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}


================================================================================


################################################################################
# File: vite.config.js
################################################################################

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'Misophonia Companion',
        short_name: 'Companion',
        description: 'A therapeutic and research PWA for misophonia.',
        start_url: '.',
        display: 'standalone',
        background_color: '#f8f6ff',
        theme_color: '#b2d8d8',
        icons: [
          {
            src: 'icon-192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'icon-512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      }
    })
  ],
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      }
    }
  }
})


================================================================================


################################################################################
# File: public/manifest.json
################################################################################

################################################################################
# File: public/manifest.json
################################################################################
{
  "name": "Misophonia Companion",
  "short_name": "Companion",
  "description": "A therapeutic and research PWA for misophonia.",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#f8f6ff",
  "theme_color": "#b2d8d8",
  "icons": [
    {
      "src": "icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}


================================================================================


################################################################################
# File: src/main.jsx
################################################################################

import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


================================================================================

